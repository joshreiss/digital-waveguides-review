<h2>KS with filter - audio worklet version</h2>
<input type='button' value='play' id='Play'><br>
<input type="range" id="pitch" oninput="pitchOut.value = pitch.value" min="0.1" max="1000" step="0.1" value="130">
<output id="pitchOut">130</output> Pitch<br>
<input type="range" id="stringDamping" oninput="stringDampingOut.value = stringDamping.value" min="0.1" max="0.7" step="0.1" value="0.5">
<output id="stringDampingOut">0.5</output> String damping<br>
<input type="range" id="pluckDamping" oninput="pluckDampingOut.value = pluckDamping.value" min="0.0" max="1.0" step="0.1" value="0.5">
<output id="pluckDampingOut">0.5</output> Pluck damping<br>
<script>
  var context = new AudioContext
  context.audioWorklet.addModule('KSWorklets.js').then(() => {
    let Noise = new AudioWorkletNode(context,'noise-generator'),
    PluckDamper = new AudioWorkletNode(context,'smoothing-filter',
      {parameterData:{pitch:130,gain:0.96,smoothingFactor:pluckDamping.value}
    }),
    NoiseGain = new GainNode(context,{gain:0}),
    output = new GainNode(context),
    feedbackDelay= new AudioWorkletNode(context,'feedbackDelay-processor',
      {parameterData:{pitch:130,gain:0.96,smoothingFactor:stringDamping.value}
    })
    Noise.connect(PluckDamper)
    PluckDamper.connect(NoiseGain)
    NoiseGain.connect(output)
    NoiseGain.connect(feedbackDelay)
    feedbackDelay.connect(output)
    output.connect(context.destination)
    Play.onclick = function() {
      context.resume()
      feedbackDelay.parameters.get('pitch').value = pitch.value
      feedbackDelay.parameters.get('smoothingFactor').value = stringDamping.value
      PluckDamper.parameters.get('smoothingFactor').value = pluckDamping.value
      let now = context.currentTime
      NoiseGain.gain.setValueAtTime(0.125, now)
      NoiseGain.gain.setValueAtTime(0, now+0.009)
      //setTimeout(() => feedbackDelay.port.postMessage('stop'), 1000)
    }
  })
</script>
