  <h1>Faust Clarinet - Web Audio Implementation</h1>
  <p>Web Audio version of Faust Clarinet by Romain Michon. Uses digital waveguide with nonlinear reed function, feedback loop & stereo spatialisation. Click Start then play using keyboard.
  <button onclick='context.resume()'>Start</button>
  <script src="faust-clarinet-web.js"></script>
  <script>
    const keyElements = {}       
    function getFrequency(noteName, octave) {// Map piano keys to frequencies
      const notes = {'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11}
      return 440 * Math.pow(2, (notes[noteName] + octave * 12 - 57) / 12)
    }   
    const keyboardMap = { // Keyboard mapping to computer keyboard (2 octaves)
      'z':{note:'C', octave:4},'s':{note:'C#', octave:4},'x':{note:'D', octave:4},'d':{note:'D#', octave:4},'c':{note:'E', octave:4},'v':{note:'F', octave:4},
      'g':{note:'F#', octave:4},'b':{note:'G', octave:4},'h':{note:'G#', octave:4},'n':{note:'A', octave:4},'j':{note:'A#', octave:4},'m':{note:'B', octave:4},
      ',':{note:'C', octave:5},'l':{note:'C#', octave:5},'.':{note:'D', octave:5},'':{note:'D#', octave:5},'/':{note:'E', octave:5}
    }    
    document.addEventListener('keydown', function(event) { // Computer keyboard control
      playNote(440)
    })
    document.addEventListener('keyup', function(event) {
      stopNote()
    }) 
    // Initialize Web Audio components
    let clarinet, context = new AudioContext()
    clarinet = new ClarinetModel(context)// Create the clarinet model
    // Connect the audio path    
  var Tone= context.createOscillator()
  var Volume= new GainNode(context,{gain:0})
  Tone.start()
  Tone.connect(Volume).connect(context.destination)
  clarinet.connect(context.destination)
    // Set up all sliders to control parameters  
      function setupSlider(id, setter, formatter = (v) => v.toFixed(2)) {// Helper function to set up sliders
        const slider = document.getElementById(id)
        const valueDisplay = document.getElementById(id + 'Value')        
        slider.addEventListener('input', function() {
          const value = parseFloat(this.value)
          valueDisplay.textContent = formatter(value)
          if (clarinet && setter) setter(value)
        })
      }
      // Basic Parameters
      clarinet.setGain(1)
      clarinet.setFrequency(440) 
      // Physical Parameters
      clarinet.setReedStiffness(0.5)
      clarinet.setNoiseGain(0)
      clarinet.setPressure(1)
      // Nonlinear Parameters
      clarinet.setNonLinearity(0)
      clarinet.setNonLinAttack(0.1)
      clarinet.setVibratoFreq(5)
      clarinet.setVibratoGain(0.1)
      clarinet.setVibratoAttack(0.5)
      clarinet.setVibratoRelease(0.01)  
      // Envelope Parameters
      clarinet.setEnvelopeAttack(0.01)
      clarinet.setEnvelopeDecay(0.05)
      clarinet.setEnvelopeRelease(0.1)  
    // Play and stop notes
    function playNote(frequency) {      
        console.log('Play', frequency)
      Volume.gain.value=1
      if (clarinet) {
        clarinet.startNote(440)
      }
    }    
    function stopNote() { if (clarinet) clarinet.stopNote(); Volume.gain.value=0 }  
  </script>